<!DOCTYPE html>

<html>
    <head>
        <title>My experiment</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="jsPsych/jspsych.js"></script>
        <script src="jsPsych/plugins/jspsych-instructions.js"></script>
        <script src="jsPsych/plugins/jspsych-xab-image.js"></script>
        <script src="jsPsych/plugins/jspsych-image-slider-response.js"></script>
        <script src="jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jsPsych/plugins/jspsych-xab-html.js"></script>
        <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <style>
    		img {
      			width: 400px;
   		 		}
  		</style>
    </head>
    <body>
    </body>
    <script>
    	/* param */
    	var feel_trialNum = 0;

        // needs to be multiple of 3
        // otherwise it will round
        var gamble_trialNum = 3;

    	/* helper trials and functions */
    	var fixate = {
    		type: "image-keyboard-response",
    		stimulus: "img/cross.jpg",
    		choices: [],
    		trial_duration: 1000
    	}

    	var slideW = {
    		type: "image-slider-response",
    		stimulus: "img/stimW.jpg",
    		labels: ["Extremely Unhappy", "Extremely Happy"],
   			data: {value: value}
   		}

   		var slideL = {
    		type: "image-slider-response",
    		stimulus: "img/stimL.jpg",
    		labels: ["Extremely Unhappy", "Extremely Happy"],
   			data: {value: value}
   		}

    	var slideDW = {
    		type: "image-slider-response",
    		stimulus: "img/stimDW.jpg",
    		labels: ["Extremely Unhappy", "Extremely Happy"],
   			data: {value: value}
   		}

		var slideDL = {
    		type: "image-slider-response",
   			stimulus: "img/stimDL.jpg",
   			labels: ["Extremely Unhappy", "Extremely Happy"],
   			data: {value: value}
	   	}

	   	var slideN = {
    		type: "image-slider-response",
   			stimulus: "img/stimN.jpg",
   			labels: ["Extremely Unhappy", "Extremely Happy"],
   			data: {value: value}
	   	}

    	function createInfo(value){
    		if (value > 0){
    			var info = {
    				type: "html-keyboard-response",
    				stimulus: "<h2>If you choose the <span style=\"color:green\">GOOD</span> picture, you will win $" + String(value) + "</h2>",
    				choices: jsPsych.NO_KEYS,
    				trial_duration: 2000
    			}
    			return info;
    		} else{
    			var info = {
    				type: "html-keyboard-response",
    				stimulus: "<h2>If you choose the <span style=\"color:red\">BAD</span> picture, you will lose $" + String(-value) + "</h2>",
    				choices: jsPsych.NO_KEYS,
    				trial_duration: 2000
    			}
    			return info;
    		}
    	}

    	function getFeedback(value){
    		zero = Math.round(Math.random());
    		if (zero == 0){
    			var feedback = {
    				type: "html-keyboard-response",
    				stimulus: "<h2>+$0</h2>",
    				choices: jsPsych.NO_KEYS,
    				trial_duration: 2000,
                    data: {earn: 0}
    			} 
    			return feedback;
    		} else if(value > 0){
    			var feedback = {
    				type: "html-keyboard-response",
    				stimulus: "<h2><span style=\"color:green\">+$" + String(value) + "</span></h2>",
    				choices: jsPsych.NO_KEYS,
    				trial_duration: 2000,
                    data: {earn: value}
    			} 
    			return feedback;
    		} else{
    			var feedback = {
    				type: "html-keyboard-response",
    				stimulus: "<h2><span style=\"color:red\">-$" + String(-value) + "</span></h2>",
    				choices: jsPsych.NO_KEYS,
    				trial_duration: 2000,
                    data: {earn: value}
    			}
    			return feedback;
    		}
    	}

    	function createFeelExpectSlide(){
    		negative = Math.round(Math.random());
    		counterbalence = Math.round(Math.random());
    		if (negative == 0){
    			if (counterbalence == 0){
    				return [slideW, slideL];
    			} else{
    				return [slideL, slideW];
    			}
    		} else{
    			if (counterbalence == 0 ){
    				return [slideDW, slideDL];
    			} else{
    				return [slideDL, slideDW];
    			}
    		}
    	}

        function createCircle(value, value2){
            var canvas = document.createElement('canvas');

            canvas.width = 400;
            canvas.height = 400;

            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.fillRect(0,0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.arc(200, 200, 180, 0 , 2*Math.PI);
            ctx.strokeStyle = "white";
            ctx.lineWidth = 5;
            ctx.stroke();

            ctx.font = "30pt Arial";
            ctx.textAlign = "center";

            if (arguments.length == 1){
              if(value == 0){
                ctx.fillStyle = "white";
                ctx.fillText("$0", 200,215);
              } else if(value < 0){
                ctx.fillStyle = "red";
                ctx.fillText("LOSE", 200, 195);
                ctx.fillText("-$" + String(-value), 200, 235);
              } else{
                ctx.fillStyle = "green";
                ctx.fillText("WIN", 200, 195)
                ctx.fillText("+$" + String(value), 200, 235);
              }
              dataURL = canvas.toDataURL();
              return "<img src=\"" + dataURL + "\">";

            } else if(arguments.length == 2){
                var counterbalence = Math.round(Math.random());
                var left = (counterbalence ? value2 : value);
                var right = (counterbalence ? value : value2);
                ctx.beginPath();
                ctx.moveTo(200, 20);
                ctx.lineTo(200, 380);
                ctx.stroke();

                if(left == 0){
                  ctx.fillStyle = "white";
                  ctx.fillText("$0", 110, 215);
                } else if(left < 0){
                  ctx.fillStyle = "red";
                  ctx.fillText("LOSE", 110, 195)
                  ctx.fillText("-$" + String(-left), 110, 235);
                } else{
                  ctx.fillStyle = "green";
                  ctx.fillText("WIN", 110, 195)
                  ctx.fillText("+$" + String(left), 110, 235);
                }

                if(right == 0){
                  ctx.fillStyle = "white";
                  ctx.fillText("$0", 290, 215);
                } else if(right < 0){
                  ctx.fillStyle = "red";
                  ctx.fillText("LOSE", 290, 195);
                  ctx.fillText("-$" + String(-right), 290, 235);
                } else{
                  ctx.fillStyle = "green";
                  ctx.fillText("LOSE", 290, 195);
                  ctx.fillText("+$" + String(right), 290, 235);
                }

              dataURL = canvas.toDataURL();
              return "<img src=\"" + dataURL + "\">";
            }
          }



    	/*style it they way I want it*/
    	$(document.body).css("background-color", "black");
    	$(document.body).css("color", "white");


    	/*instruction*/

    	var instruction_block = {
    		type: "instructions",
    		pages: ["Welcome to the experiment. Press \"Next\" to continue.",
    				"<p>In this experiment, you will see several pairs of shapes and choose between them.</p>" +
      				"<p>One of the shapes is associated with a gain or a loss between $0.20 - $12.</p>" + 
    				"<p>The other shape does not have a gain or a loss. In other words, the amount is 0.</p>" +
    				"<p>Press \"Next\" to continue.</p>",
    				"<p>Before each pair of shapes, you will be told the amount that you could win or lose.</p>" + 
    				"<p>You will be asked how you would feel if you lost or wone</p>" + 
    				"<p>Please press Q to choose the left and P for the right.</p>" + 
    				"<p>Press \"Next\" to begin the experiment.</p>"],
    		show_clickable_nav: true,
    		allow_backward: false
    	};

    	var instruction_block2 = {
    		type: "instructions",
    		pages: ["<p>Now you will be asked how you feel after you choose the shapes</p>" + 
    				"<p>Press \'Next\' to continue.</p>"],
    		show_clickable_nav: true,
    		allow_backward: false
    	}

    	/*feeling expected task*/

        // init trial param
    	var feel_expect_value = [];
    	for(var i = (2/10); i <= 12; i += (2/10)){
    		feel_expect_value.push(parseFloat((i).toFixed(1)));
    		feel_expect_value.push(-parseFloat((i).toFixed(1)));
    	}

    	feel_expect_value = jsPsych.randomization.sampleWithoutReplacement(feel_expect_value, feel_trialNum);

    	var feel_expect_img_L = new Array(feel_trialNum);
    	var feel_expect_img_R = new Array(feel_trialNum);
    	for(var i = 1; i <= feel_trialNum; i += 1){
    		feel_expect_img_L[i - 1] = i;
    		feel_expect_img_R[i - 1] = i;
    	}

    	feel_expect_img_L = jsPsych.randomization.shuffle(feel_expect_img_L);
    	feel_expect_img_R = jsPsych.randomization.shuffle(feel_expect_img_R);

    	feel_expect = []

        // create trial param
    	for(var i = 1; i <= feel_trialNum; i+=1){
    		var value = feel_expect_value[i - 1];
    		var counterbalence = Math.round(Math.random());
    		
    		var trial = {
				type: "xab-image",
				x_duration: 0,
				x_duration_gap: 0,
				stimuli: (counterbalence == 0 ? ["img/stim1.jpg", "img/stim2.jpg"] : ["img/stim2.jpg", "img/stim1.jpg"])
			}

    		feel_expect.push(fixate);
    		feel_expect.push(createInfo(value));
    		feel_expect = feel_expect.concat(createFeelExpectSlide());
    		feel_expect.push(trial);
    		feel_expect.push(getFeedback(value));

    	}

    	/*feel experience */

        // init trial param
    	var feel_experience_value = [];
    	for(var i = (2/10); i <= 12; i += (2/10)){
    		feel_experience_value.push(parseFloat((i).toFixed(1)));
    		feel_experience_value.push(-parseFloat((i).toFixed(1)));
    	}

    	feel_experience_value = jsPsych.randomization.sampleWithoutReplacement(feel_experience_value, feel_trialNum);

    	var feel_experience_img_L = new Array(feel_trialNum);
    	var feel_experience_img_R = new Array(feel_trialNum);
    	for(var i = 1; i <= feel_trialNum; i += 1){
    		feel_experience_img_L[i - 1] = i;
    		feel_experience_img_R[i - 1] = i;
    	}

    	feel_experience_img_L = jsPsych.randomization.shuffle(feel_experience_img_L);
    	feel_experience_img_R = jsPsych.randomization.shuffle(feel_experience_img_R);

    	feel_experience = [];

    	feel_experience.push(instruction_block2);

        // create trials
    	for(var i = 1; i <= feel_trialNum; i+=1){

       		value = feel_experience_value[i - 1];
    		counterbalence = Math.round(Math.random());

    		var trial = {
				type: "xab-image",
				x_duration: 0,
				x_duration_gap: 0,
				stimuli: (counterbalence == 0 ? ["img/stim1.jpg", "img/stim2.jpg"] : ["img/stim2.jpg", "img/stim1.jpg"])
			}

    		feel_experience.push(fixate);
    		feel_experience.push(createInfo(value));
    		feel_experience.push(trial);
    		feel_experience.push(getFeedback(value));
    		feel_experience.push(slideN);
    	}

        /*gambling task */

        // init instructions
        var instruction_block3 = {
            type: "instructions",
            pages: ["<p>Now you will see a series of monetary choices. One of the choice will be a sure option, and the other will be a 50/50 option.</p>" +
                    "<p>The results of one randomly selected trial will be added to your payment.</p>" +
                    "<p>Press \"Next\" to continue."],
            show_clickable_nav: true,
            allow_backward: false
        }

        var gambleNum = Math.round(gamble_trialNum / 3);

        // init trial types randomzied
        var gamble_trial_type = [];
        for(var i = 1; i <= gambleNum; i+=1){
            gamble_trial_type.push("mixed");
            gamble_trial_type.push("gain");
            gamble_trial_type.push("loss");
        }

        // mixed Trials: x = [0.2,12]; win = x, lose = -x, sure = 0
        // gain Trials: high = [6.2,12], low = [0.2, 6]; win = high, lose = 0, sure = low
        // losee Trials: high = [6.2,12], low = [0.2, 6]; win = 0, lose  = -high, sure = -low

        gamble_trial_type = jsPsych.randomization.shuffle(gamble_trial_type);

        // init trial values
        var win = [];
        var lose = []
        var sure = [];

        var gamble_value = []
        var gamble_high_value = [];
        var gamble_low_value = [];

        for(var i = (2/10); i <= 12; i+=(2/10)){
            gamble_value.push(parseFloat((i).toFixed(1)));
            if(i <= 6){
                gamble_low_value.push(parseFloat((i).toFixed(1)));
            } else{
                gamble_high_value.push(parseFloat((i).toFixed(1)));
            }
        }

        // mixed param
        var gamble_value = jsPsych.randomization.sampleWithoutReplacement(gamble_high_value, gamble_trialNum);

        // gain param
        var gamble_gain_high_value = jsPsych.randomization.sampleWithoutReplacement(gamble_high_value, gamble_trialNum);
        var gamble_gain_low_value = jsPsych.randomization.sampleWithoutReplacement(gamble_low_value, gamble_trialNum);

        // loss param
        var gamble_loss_high_value = jsPsych.randomization.sampleWithoutReplacement(gamble_high_value, gamble_trialNum);
        var gamble_loss_low_value = jsPsych.randomization.sampleWithoutReplacement(gamble_low_value, gamble_trialNum);

        for(var i = 1; i <= gamble_trial_type.length; i+=1){
            var trial_type = gamble_trial_type[i - 1];
            if(trial_type == "mixed"){
                var x = gamble_value.shift();
                win.push(x);
                lose.push(-x);
                sure.push(0);
            }else if(trial_type == "gain"){
                win.push(gamble_gain_high_value.shift());
                lose.push(0);
                sure.push(gamble_gain_low_value.shift());
            }else if(trial_type == "loss"){
                win.push(0);
                lose.push(-gamble_loss_high_value.shift());
                sure.push(-gamble_loss_low_value.shift());
            }
        }

        // init Trials

        gamble = [];
        gamble.push(instruction_block3);
        for(var i = 1; i <= gamble_trial_type.length; i+=1){
            var gamble_side = (Math.round(Math.random()) ? "R" : "L");
            console.log(gamble_side);
            var trial_win = win[i - 1];
            var trial_lose = lose[i - 1];
            var trial_sure = sure[i - 1];
            var trial = {
                type: 'xab-html',
                stimuli: ((gamble_side == "R") ? [createCircle(trial_sure), createCircle(trial_win, trial_lose)] : [createCircle(trial_win, trial_lose), createCircle(trial_sure)]),
                x_duration: 0,
                x_duration_gap: 0,
                data: {gamble_trial_type: gamble_trial_type[i - 1], win:trial_win, lose:trial_lose, sure:trial_sure, gamble_side:gamble_side}
            }
            gamble.push(fixate);
            gamble.push(trial);

        }

    	/*init timeline*/
    	var  timeline = [];
    	timeline.push(instruction_block);
    	timeline = timeline.concat(feel_expect);
    	timeline = timeline.concat(feel_experience);
        timeline = timeline.concat(gamble);
    	/*init expt*/
    	jsPsych.init({
    		timeline: timeline,
    		on_finish: function(){
    			jsPsych.data.displayData();
    		}
    	});

    </script>
</html>


